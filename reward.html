<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WinQuizBot ‚Äî Get Joker</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; text-align:center; padding:36px; }
    .card { max-width:640px; margin:24px auto; padding:20px; border-radius:8px; box-shadow:0 6px 24px rgba(0,0,0,0.08); }
    button { padding:10px 18px; font-size:16px; margin:8px; cursor:pointer; border-radius:6px; border: none; }
    #status { margin-top:14px; font-weight:600; }
    a.button-like { display:inline-block; padding:10px 18px; border-radius:6px; text-decoration:none; background:#0078D4; color:#fff; }
  </style>
</head>
<body>
  <div class="card">
    <h2 id="title">üé• Watch ad ‚Äî get a joker</h2>
    <p id="desc">Please watch a short ad. After completion your joker will be credited.</p>

    <div id="controls">
      <button id="watchBtn">‚ñ∂Ô∏è Watch ad</button>
      <button id="claimBtn">‚úÖ Claim reward</button>
    </div>

    <p id="help" style="font-size:14px; color:#444"></p>
    <div id="status"></div>
  </div>

  <script>
    // --- Texte (DE / EN)
    const TEXTS = {
      en: {
        title: "üé• Watch an ad ‚Äî claim a daily joker",
        desc: "Watch the ad. After it ends, press \"Claim reward\" to receive your joker.",
        watchBtn: "‚ñ∂Ô∏è View Ad",
        claimBtn: "‚úÖ Claim Reward",
        already: "‚ùó You've already claimed today's joker.",
        success: "‚úÖ Joker credited! Check your bot ‚Äî then press ‚ñ∂Ô∏è Continue to resume the quiz.",
        error: "‚ùå Error while requesting reward. Try again later.",
        waiting: "Please wait ‚Äî loading the ad...",
        noAd: "‚ö†Ô∏è Ad provider not available. Use the Claim button after you've watched any fallback ad."
      },
      de: {
        title: "üé• Werbung ansehen ‚Äî t√§glichen Joker holen",
        desc: "Sieh dir die Werbung an. Danach auf ‚ÄûBelohnung abholen‚Äú klicken, um deinen Joker zu erhalten.",
        watchBtn: "‚ñ∂Ô∏è Werbung ansehen",
        claimBtn: "‚úÖ Belohnung abholen",
        already: "‚ùó Du hast den heutigen Joker bereits eingel√∂st.",
        success: "‚úÖ Joker gutgeschrieben! Schau im Bot nach ‚Äî dann kannst du das Quiz fortsetzen.",
        error: "‚ùå Fehler beim Einl√∂sen. Versuche es sp√§ter noch einmal.",
        waiting: "Bitte warten ‚Äî Werbung wird geladen...",
        noAd: "‚ö†Ô∏è Werbung nicht verf√ºgbar. Nutze danach den Belohnungs-Button."
      }
    };

    function params() {
      return new URLSearchParams(window.location.search);
    }
    const urlParams = params();
    const userId = urlParams.get("userid") || urlParams.get("tgid") || urlParams.get("user_id") || "";
    const lang = (urlParams.get("lang") || "en").startsWith("de") ? "de" : "en";
    const t = TEXTS[lang];

    // Elements
    const titleEl = document.getElementById("title");
    const descEl  = document.getElementById("desc");
    const watchBtn = document.getElementById("watchBtn");
    const claimBtn = document.getElementById("claimBtn");
    const statusEl = document.getElementById("status");
    const helpEl   = document.getElementById("help");

    // Init UI text
    titleEl.textContent = t.title;
    descEl.textContent = t.desc;
    watchBtn.textContent = t.watchBtn;
    claimBtn.textContent = t.claimBtn;
    helpEl.textContent = "";

    // LocalStorage key (per user)
    function lastClaimKey(uid){ return `winquiz_last_claim_${uid}`; }
    function claimedToday(uid) {
      if(!uid) return false;
      const key = lastClaimKey(uid);
      const v = localStorage.getItem(key);
      if(!v) return false;
      return v === new Date().toISOString().slice(0,10);
    }
    function markClaimed(uid) {
      if(!uid) return;
      const key = lastClaimKey(uid);
      localStorage.setItem(key, new Date().toISOString().slice(0,10));
    }

    function showStatus(msg){ statusEl.textContent = msg; }
    function setHelp(msg){ helpEl.textContent = msg; }

    // Reward call
    async function rewardUser() {
      if(!userId) {
        alert("User id missing");
        return;
      }
      if(claimedToday(userId)) {
        showStatus(t.already);
        return;
      }

      try {
        showStatus(t.waiting);
        // call your bot reward endpoint
        const url = `https://thebot-am7g.onrender.com/reward?userid=${encodeURIComponent(userId)}`;
        const res = await fetch(url, { method: "GET" });
        if(res.ok) {
          markClaimed(userId);
          showStatus(t.success);
        } else {
          const txt = await res.text().catch(()=>"");
          console.warn("Reward response not OK:", res.status, txt);
          showStatus(t.error);
        }
      } catch(err) {
        console.error(err);
        showStatus(t.error);
      }
    }

    // Try to show Monetag ad (if available)
    async function showRewardedAd() {
      setHelp("");
      if(!userId) {
        setHelp("Missing userid in URL.");
        return;
      }

      // If already claimed today -> inform user and still allow manual claim (for testing)
      if(claimedToday(userId)) {
        showStatus(t.already);
      }

      // Monetag API function name (used previously)
      if(typeof show_9422332 === "function") {
        setHelp(t.waiting);
        try {
          await show_9422332();
          // after ad completed, optionally auto-claim:
          await rewardUser();
        } catch(e) {
          console.warn("Ad failed:", e);
          setHelp(t.noAd);
        }
      } else {
        // Monetag not present on this page (fallback)
        setHelp(t.noAd);
      }
    }

    // Buttons
    watchBtn.addEventListener("click", async ()=>{
      setHelp(t.waiting);
      // If ad function exists call it; otherwise tell user
      if(typeof show_9422332 === "function") {
        try {
          await show_9422332();
          setHelp("");
          // let user click Claim (or auto claim)
          // we do NOT auto-run reward here to give the user control
        } catch(e) {
          console.warn("Ad show failed", e);
          setHelp(t.noAd);
        }
      } else {
        setHelp(t.noAd);
      }
    });

    claimBtn.addEventListener("click", async ()=>{
      await rewardUser();
    });

    // Auto-run on load: try to show ad (keeps UX simple)
    window.addEventListener("load", ()=>{
      // small delay to let ad script load
      setTimeout(showRewardedAd, 700);
    });
  </script>

  <!-- Monetag script (if you use Monetag widget) -->
  <script src="https://rewardedads.monetag.com/show_9422332.js" async></script>
</body>
</html>
